formatTitle=function(a){return a.substring(0,a.lastIndexOf("-"))};function responsivefy(d){var g={top:1,right:0,bottom:6,left:50},f=i_width_sankey-g.right-g.left,a=($(window).outerHeight(true)-100-180);var b=d3.select(d.node().parentNode),f=parseInt(d.style("width")),a=parseInt(d.style("height")),c=f/a;d.attr("viewBox","0 0 "+f+" "+a).attr("perserveAspectRatio","xMinYMid").call(e);d3.select(window).on("resize."+b.attr("id"),e);function e(){assignAbsolutes();var k={top:1,right:0,bottom:6,left:50},j=i_width_sankey-k.right-k.left,h=($(window).outerHeight(true)-140);var i=parseInt(b.style("width"));d.attr("width",j);d.attr("height",h+k.top+k.bottom)}}var svg_sankey;drawSankey=function(g){a_visible_pathtext_label_ids=[];var f={top:1,right:0,bottom:6,left:50},a=(i_width_sankey-f.right-f.left),l=($(window).outerHeight(true)-140);var c=d3.format(",.0f"),j=function(p){return c(p)},h=d3.scale.category20();$("#div_flow_chart").empty();svg_sankey=d3.select("#div_flow_chart").append("svg").attr("id","svg_sankey").attr("width",a).attr("height",l+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")");var o=d3.sankey().nodeWidth(15).nodePadding(10).size([a,l]);var n=o.link();o.nodes(g.nodes).links(g.links).layout(32);var m=d3.select("div.tooltip2");var i=svg_sankey.append("g").selectAll(".link").data(g.links).enter().append("path").attr("class","link").attr("d",n).attr("id",function(q,p){return"pathid_"+p}).attr("cnt",function(p){return Math.round(p.value)}).attr("sourceid",function(p){return p.source.name}).attr("targetid",function(p){return p.target.name}).style("stroke-width",function(p){return Math.max(1,p.dy)}).on("mouseover",function(p){$(".tooltip2").html(p.value+" ("+Math.round(((p.value/i_count_total)*100))+"%)");return m.style("top",(d3.event.pageY-50)+"px").style("left",(d3.event.pageX+10)+"px").style("visibility","visible")}).on("mousemove",function(){return m.style("top",(d3.event.pageY-50)+"px").style("left",(d3.event.pageX+10)+"px")}).on("mouseout",function(){return m.style("visibility","hidden")}).sort(function(q,p){return p.dy-q.dy});var e=svg_sankey.append("g").selectAll(".node").data(g.nodes).enter().append("g").attr("class","node").attr("transform",function(p){return"translate("+p.x+","+p.y+")"}).attr("nodeid",function(p){return p.name}).call(d3.behavior.drag().origin(function(p){return p}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",k));e.append("rect").attr("height",function(p){return p.dy}).attr("width",o.nodeWidth()).style("fill",function(p){return p.color=h(p.name.replace(/-\d+$/,""))}).style("stroke",function(p){return d3.rgb(p.color).darker(2)}).style("stroke-width",0).on("mouseover",function(p){$(".tooltip2").html(formatTitle(p.name)+"<br>"+c(p.value)+" ("+Math.round(((p.value/i_count_total)*100))+"%)");return m.style("top",(d3.event.pageY-50)+"px").style("left",(d3.event.pageX+10)+"px").style("visibility","visible")}).on("mousemove",function(){return m.style("top",(d3.event.pageY-50)+"px").style("left",(d3.event.pageX+10)+"px")}).on("mouseout",function(){return m.style("visibility","hidden")});e.append("text").attr("x",-6).attr("y",function(p){return p.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(q){var p=q.name.substring(0,q.name.lastIndexOf("-"));return p}).filter(function(p){return p.x<a/2}).attr("x",6+o.nodeWidth()).attr("text-anchor","start");var d=svg_sankey.selectAll(".labelText").data(g.links).enter().append("text").attr("class","labelText").attr("id",function(q,p){return"textpathid_"+p}).style("visibility","hidden").style("fill","#000000").attr("dx",50).attr("dy",0).append("textPath").attr("xlink:href",function(q,p){return document.URL+"#pathid_"+p}).text(function(q,p){return c(q.value)+" ("+Math.round(((q.value/i_count_total)*100))+"%)"});function k(p){d3.select(this).attr("transform","translate("+p.x+","+(p.y=Math.max(0,Math.min(l-p.dy,d3.event.y)))+")");o.relayout();i.attr("d",n)}var b=getMinMaxEdgeCnt();setTimeout(function(){$("#div_flow_slider").css("width",(i_width_sankey-568)+"px");if(i_sankey_slider_created==0){createSankeySlider(b[0],b[1])}},0);assignAbsolutes();if($("#div_flow_filter").css("display")=="none"){$("#slider-range-flow").css("width",(i_width_sankey-118)+"px")}else{$("#slider-range-flow").css("width",(i_width_sankey-618)+"px")}};var s_sankey_colors="NONE";setSankeyColors=function(a){s_sankey_colors=a;sankeyColors()};sankeyColors=function(){if(s_sankey_colors=="NONE"){var a=d3.select("#div_flow_chart").selectAll(".link").style("stroke",function(b){return"#cccccc"}).attr("stroke-opacity",0.7)}else{if(s_sankey_colors=="SOURCE"){var a=d3.select("#div_flow_chart").selectAll(".link").style("stroke",function(b){return d3.rgb(b.source.color)}).attr("stroke-opacity",0.7)}else{if(s_sankey_colors=="TARGET"){var a=d3.select("#div_flow_chart").selectAll(".link").style("stroke",function(b){return d3.rgb(b.target.color)}).attr("stroke-opacity",0.7)}}}};getMinMaxEdgeCnt=function(){var a=0;var b=0;$("path").each(function(){if(typeof $(this).attr("cnt")!=="undefined"){var c=parseInt($(this).attr("cnt"));if(a==0||c<a){a=c}if(c>b){b=c}}});i_min_flow_real=a;i_max_flow_real=b;return[a,b]};var a_visible_pathtext_label_ids=[];var i_sankey_slider_low,i_sankey_slider_high;sankeySliderEngage=function(){var a=[];$("#div_flow path").each(function(){var b="text"+$(this).attr("id");$("#"+b).css("visibility","hidden");if(parseInt($(this).attr("cnt"))>=i_sankey_slider_low&&parseInt($(this).attr("cnt"))<=i_sankey_slider_high){$(this).css("visibility","visible");if(i_toggle_sankey_label%2==1){$("#"+b).css("visibility","visible")}if(jQuery.inArray($(this).attr("sourceid"),a)==-1){a.push($(this).attr("sourceid"))}if(jQuery.inArray($(this).attr("targetid"),a)==-1){a.push($(this).attr("targetid"))}}else{$(this).css("visibility","hidden")}viewSankeyLabels(0)});$("#div_flow g").each(function(){if($(this).attr("nodeid")!=null){if(jQuery.inArray($(this).attr("nodeid"),a)!==-1){$(this).css("visibility","visible")}else{$(this).css("visibility","hidden")}}});$("#amount").val(i_sankey_slider_low+" - "+i_sankey_slider_high)};var i_sankey_slider_created=0;createSankeySlider=function(b,a){$("#slider-range-flow").slider({range:true,min:b,max:a,values:[b,a],slide:function(c,d){$("#amount").val(d.values[0]+" - "+d.values[1]);i_sankey_slider_low=d.values[0],i_sankey_slider_high=d.values[1];sankeySliderEngage()}});i_sankey_slider_created=1};var s_sankey_labels="hidden";var i_toggle_sankey_label=0;toggleSankeyLabels=function(){i_toggle_sankey_label++;i_sankey_slider_low=$("#slider-range-flow").slider("values",0),i_sankey_slider_high=$("#slider-range-flow").slider("values",1);sankeySliderEngage()};viewSankeyLabels=function(a){};